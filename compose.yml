
x-common:
  backend: &backend_env
    BACKEND_URL: "http://web:5000"
  database: &database_env
    DATABASE_URL: postgresql://user:password@db:5432/lafdb
  celery: &celery_env
    CELERY_BROKER_URL: redis://redis:6379/0
    CELERY_RESULT_BACKEND: redis://redis:6379/0

services:
  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=lafdb
    ports:
      - "5432:5432"

  redis:
    image: redis:6-alpine

  web:
    build: ./app/backend
    command: gunicorn --bind 0.0.0.0:5000 laf.app:app
    volumes:
      - ./app/backend:/app
    ports:
      - "5000:5000"
    environment:
      <<: [*backend_env, *database_env, *celery_env]
    depends_on:
      - db
      - redis

  worker:
    build: ./app/backend
    command: poetry run celery -A laf.tasks worker --loglevel=info
    volumes:
      - ./app/backend:/app
    environment:
      <<: [*backend_env, *database_env, *celery_env]
    depends_on:
      - web
      - redis

  instrument-a:
    build: ./app/instruments/instrument-a
    volumes:
      - ./app/instruments/instrument-a:/app
    environment:
      <<: *backend_env
    depends_on:
      - web

  instrument-b:
    build: ./app/instruments/instrument-b
    volumes:
      - ./app/instruments/instrument-b:/app
    environment:
      <<: *backend_env
    depends_on:
      - web

  frontend:
    build:
      context: ./app/frontend
      args:
        USER_ID: ${UID}
    volumes:
      - ./app/frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_URL=${VITE_API_URL}
    depends_on:
      - web

  nifi:
    image: apache/nifi:latest
    ports:
      - "8080:8080"
    environment:
      - NIFI_WEB_HTTP_PORT=8080
    volumes:
      - nifi_data:/opt/nifi/nifi-current/data

  kafka:
    image: bitnami/kafka:latest
    ports:
      - "9092:9092"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_LISTENERS=PLAINTEXT://:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    depends_on:
      - zookeeper

  zookeeper:
    image: bitnami/zookeeper:latest
    ports:
      - "2181:2181"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes

  airflow:
    image: apache/airflow:2.7.2
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__SQL_ALCHEMY_CONN=postgresql+psycopg2://user:password@db:5432/lafdb
      - AIRFLOW__CORE__FERNET_KEY=your_fernet_key
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
    volumes:
      - airflow_data:/opt/airflow
    ports:
      - "8081:8080"
    depends_on:
      - db
      - redis

  atlas:
    image: apache/atlas:latest
    ports:
      - "21000:21000"
    environment:
      - ATLAS_DB_TYPE=postgres
      - ATLAS_DB_HOST=db
      - ATLAS_DB_USER=user
      - ATLAS_DB_PASS=password
      - ATLAS_DB_NAME=lafdb
    depends_on:
      - db

  ranger:
    image: apache/ranger:latest
    ports:
      - "6080:6080"
    environment:
      - DB_FLAVOR=POSTGRES
      - SQL_CONNECTOR=postgresql
      - DB_HOST=db
      - DB_NAME=lafdb
      - DB_USER=user
      - DB_PASSWORD=password
    depends_on:
      - db

volumes:
  postgres_data:
  nifi_data:
  airflow_data:
